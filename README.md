# alice-smarthome
Простейший сервер для работы с умным домом от Яндекса

## Требования
- Node.js 18 или выше
- Домен
- SSL-сертификат или любой другой способ обеспечения безопасного соединения

## How to: установка
Как настраивать умный дом на странице [Диалогов](https://dialogs.yandex.ru/developer) - разберётесь сами. Этот процесс пошагово описал Cluster в [своей утилите для работы с умным домом](https://github.com/ClusterM/alice-smart-home)
1. `git clone https://github.com/MagicSweet-dev/alice-smarthome`
0. `cd alice-smarthome`
0. `npm install`
0. `npm run build`
0. `cd build`
0. `cp -R .* ~/services/smarthome` <- или любая другая папка
0. `cd ~/services/smarthome`
0. редактируем конфиг в `config/config.json5`
0. `node .`\
Готово. Теперь можно настраивать прокси. Всё, что нужно сделать - перенаправить трафик, для этого рекомендую к использованию [Caddy](https://caddyserver.com/), `caddy reverse-proxy --from your-domain.com --to :3000`, где 3000 - стандартный порт, а your-domain.com - домен с A и/или AAAA записью, указывающей на вас.

## How to: использование
Весь движ происходит в папке `devices`.\
Одна папка - одно устройство, для примера уже есть computer (без `config.json5`, там *пароли*)
- device.config.json5\
То, что будет отправляться Яндексу. Синтаксис согласно [документации](https://yandex.ru/dev/dialogs/smart-home/doc/reference/get-devices.html)
- index.js
  - функция `on(string, (string, any) => string | undefined)`\
  Первый параметр - название (id) умения. Функция (второй параметр) будет вызвана, когда пользователь захочет поменять состояние умения этого устройства.\
  Второй параметр - пара instance-value, согласно [документации](https://yandex.ru/dev/dialogs/smart-home/doc/concepts/capability-types.html). Если вернуть тип string, функция будет считаться завершенной с ошибкой. Вернувшаяся строчка - описание этой ошибки.
  - функция `query(string, () => {string, any} | string | undefined)`\
  **Внимание**: вызывается только тогда, когда умение является retrievable\
  Первый параметр - название (id) умения. Функция (второй параметр) будет вызвана, когда сервис умного дома захочет посмотреть, какое сейчас состояние у устройства.\
  Второй параметр - функция, возввращающая пару instance-value, согласно [документации](https://yandex.ru/dev/dialogs/smart-home/doc/concepts/capability-types.html). Если вернуть тип string, функция будет считаться завершенной с ошибкой. Вернувшаяся строчка - описание этой ошибки.\
  Также в этих функциях можно выкидывать ошибки ключевым словом `throw`. Репрезентация ошибки в виде строчки - описание ошибки.
  
## Стоит помнить
Авторизация на сервисе Яндекса может пройти успешно **только один раз**! Чтобы пройти авторизацию повторно, необходимо записать в файл `config/authentication.json5` стандартное значение `{}`